FROM mklee03/hpc_stack:9.4.0

ARG fms_version=main

ENV FMS_ROOT=/FMS/gcc/9.4.0

RUN git clone https://github.com/NOAA-GFDL/FMS.git /FMS/src \
  && cd /FMS/src && git checkout $fms_version               \
  && mkdir /FMS/build && cd /FMS/build                      \
  && export NetCDF_ROOT=`nc-config --prefix`                \
  && cmake -DCMAKE_INSTALL_PREFIX=$FMS_ROOT -DOPENMP=ON -D32BIT=ON -D64BIT=ON -DGFS_PHYS=ON /FMS/src \
  && make install \
  && rm -rf /FMS/build

FROM mklee03/hpc_stack:9.4.0
COPY --from=0 /FMS /FMS

ENV FMS_ROOT=/FMS/gcc/9.4.0

ENTRYPOINT [ "/bin/bash" ]